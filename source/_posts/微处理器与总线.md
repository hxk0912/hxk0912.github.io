---
title: 微处理器与总线
date: 2020-02-26 08:08:44
tags:
categories: 微机原理与接口技术
---

## 8086内部结构

![alt](http://m.qpic.cn/psc?/V11NehB63qJi50/9vuGDcz9AP*EJeMjs9i.nmeCHdj7WnYmD2HAWANj4.hiS8n0RL2Ms1nbtiM1n12J9cr5wQb.N3RmH2okoDXlRzcLegn*rAwFZRnJdMytI8s!/b&bo=ZQODAgAAAAADB8U!&rf=viewer_4)

执行部件EU (execution unit):

* 负责指令的译码、执行和数据的运算

总线接口部件BIU (bus interface unit):

* 管理CPU与系统总线的接口
* 负责CPU对存储器和外设进行访问

两个单元在大多数情况下独立操作，还可以并行执行，执行上一个命令同时读取下一个命令。

## 8086/8088寄存器组

* 8个通用寄存器
* 4个段寄存器
* 1个标志寄存器
* 1个指令指针寄存器

### 通用寄存器

* 数据寄存器:  AX   BX   CX   DX
* 变址寄存器:  SI    DI
* 指针寄存器:  BP   SP

4个数据寄存器还可以分成高8位和低8位2个独立的寄存器
8个通用8位寄存器
AX： AH   AL    BX： BH   BL
CX： CH   CL    DX： DH   DL

* AX-累加器（accumulator） 使用频度最高，用于算术、逻辑运算以及与外设传送信息等

8位累加器为AL

* BX-基址寄存器（base address register） 常用做存放存储器地址
* CX-计数器（counter） 作为循环和串操作等指令中的隐含计数器
* DX-数据寄存器（data register） 常用来存放双字长数据的高16位，或存放外设端口地址

16位变址寄存器SI和DI，常用于存储器变址寻址方式时提供地址

* SI   源地址寄存器（source index）
* DI  目的地址寄存器（destination index）

指针寄存器用于寻址内存堆栈内的数据

* SP    堆栈指针寄存器（stack Pointer） 指示堆栈段栈顶的位置（偏移地址）
* BP   基址指针寄存器（base pointer） 表示数据在堆栈段中的基地址

### 指令指针寄存器

IP 指令指针寄存器（instruction pointer）

* 指示主存储器指令的位置
* 随着指令的执行，IP将自动修改以指示下一条指令所在的存储器位置
* IP寄存器是一个专用寄存器

IP寄存器与CS段寄存器联合使用以确定下一条指令的存储单元地址

**程序中不能直接使用IP寄存器**

### 标志

标志（flag）用于反映指令执行结果或控制指令执行形式。

处理器的各种标志形成了1个16位的标志寄存器FLAGS（程序状态字PSW寄存器）。

* CF 进位标志 进位CF=1
* ZF 零标志   运算结果为0，ZF=1
* SF 符号标志 运算结果最高位为1，SF=1
* PF 奇偶标志 运算结果最低8位中“1”的个数为偶数，PF=1
* OF 溢出标志 算术运算结果有溢出，OF=1
* AF 辅助进位标志 运算时D3位有进位或借位时，AF=1
* DF 方向标志 用于串操作指令中，控制地址的变化方向。DF=0时，存储器地址自动增加。
* IF 中断允许标志 允许中断，IF=1。
* TF 陷阱标志 单步执行指令时，TF=1

### 段寄存器

* CS-代码段寄存器（code segment） 指明当前代码段的起始地址
* DS-数据段寄存器（data segment） 指明当前数据段的起始地址
* ES-附加段寄存器（extra segment） 指明当前附加段的起始地址
* SS-堆栈段寄存器（stack segment） 指明当前堆栈段的起始地址

## 存储器结构

每个存储单元都有一个编号，被称为存储器地址

每个存储单元存放一个字节的内容

0002H单元存放有一个数据34H，表达为	[0002H]＝34H

### 小端方式

多字节数据在存储器中占连续的多个字节存储单元存放时，低字节存入低地址，高字节存入高地址；

表达时，用它的低地址表示多字节数据占据的地址空间。

[0002H]＝1234H时 0002H存入34H，0003H存入12H

## 存储器的分段管理

### 段基地址和偏移地址

#### 段基地址

* 指明逻辑段在主存储器中的起始位置
* 必须是16的整数倍！ 
* 即：xxxx0H省略低4位0000B, 段地址可用16位数据表示, 因此，就能用16位段寄存器表达段基地址。

#### 偏移地址

* 指明存储器单元距离段起始位置的偏移量
* 每段不超过64KB, 偏移地址也可用16位数据表示
* 也称有效地址EA（effective address）

### 物理地址和逻辑地址

#### 物理地址

PA 8086/8088的存储系统中，对应每个存储单元都有一个唯一的20位编号；范围：00000H ~ FFFFFH。

#### 逻辑地址

程序员编程时采用。

#### 转换

物理地址：12345H
逻辑地址：1234H：0005H

**一个物理地址可能对应很多个逻辑地址，但是逻辑地址的最低4位一定与物理地址最低4位相同。**

### 段寄存器 - 段寄存器

#### 代码段

代码段用来存放程序的指令序列

CS：存放代码段的段基地址
IP：指示下条指令的偏移地址

处理器利用CS: IP取得下一条要执行的指令

#### 数据段

数据段存放运行程序所用的数据

DS：存放数据段的段基地址
有效地址EA：存储器操作数的偏移地址

处理器利用DS: EA存取数据段中的数据

#### 附加段

附加段是附加的数据段，也保存数据

ES：存放附加段的段基地址
有效地址EA：存储器操作数的偏移地址

处理器利用ES: EA存取附加段中的数据

串操作指令将附加段作为其目的操作数的存放区域

#### 堆栈段

堆栈段确定堆栈所在的主存区域

SS：存放堆栈段的段基地址
SP：指示堆栈栈顶的偏移地址

处理器利用SS: SP操作堆栈顶的数据

### 段超越

没有指明时，一般的数据访问在DS段。默认的情况允许改变，需要使用段超越前缀。

* CS: 代码段超越，使用代码段的数据
* SS: 堆栈段超越，使用堆栈段的数据
* DS: 数据段超越，使用数据段的数据
* ES: 附加段超越，使用附加段的数据

没有段超越的指令实例：
MOV AX, [2000H]  ; AX←DS:[2000H]；
从默认的DS数据段取出数据

采用段超越前缀的指令实例：
MOV AX, ES:[2000H]; AX←ES:[2000H]；
从指定的ES附加段取出数据

![alt](http://m.qpic.cn/psc?/V11NehB63qJi50/9vuGDcz9AP*EJeMjs9i.ngrdm4OgDy0whWuuZKl0TKFeFTMWctYPHRsIjHrjw6vY9ePJOeyThCaEVi2el8DeIc2j8Z.k6HvGOc.rhmjw1Ps!/b&bo=WAPhAQAAAAADB5k!&rf=viewer_4)

## CPU引脚

### 地址/数据总线

* AD<sub>7</sub> ~ AD<sub>0</sub>

  + 地址/数据分时复用，双向、三态
  + T<sub>1</sub>时刻输出低8位地址A<sub>7</sub> ~ A<sub>0</sub>
  + 其他时间用于传送8位数据D<sub>7</sub> ~ D<sub>0</sub>

* A<sub>15</sub> ~ A<sub>8</sub>

  + 中间8位地址，输出、三态
  + 提供20位地址的中间8位地址A<sub>15</sub> ~ A<sub>8</sub>

### 分时复用

分时复用就是一个引脚在不同的时刻具有两个甚至多个作用。
最常见的总线复用是数据和地址引脚复用。
分时复用的目的是为了减少对外引脚个数。

### 地址/状态总线

* A<sub>19</sub>/S<sub>6</sub> ~ A<sub>16</sub>/S<sub>3</sub>

  + 地址/状态分时复用，输出、三态
  + 访问存储器的T1输出高4位地址A<sub>19</sub> ~ A<sub>16</sub>
  + 访问外设的T1时刻全部输出低电平
  + 其他时间输出状态信号S<sub>6</sub> ~ S<sub>3</sub>

### 控制总线

* ALE（address latch enable）

  + 地址锁存允许，输出、三态、高电平有效
  + 有效时，表示引脚AD7 ~ AD0和A19/S6 ~ A16/S3正在传送地址信息
  + 由于地址信息在这些复用引脚上出现的时间很短暂，所以系统可以利用ALE引脚将地址锁存起来

  

* IO/M (input and output/memory）

  + I/O或存储器访问选择，输出、三态
  + 高电平，表示CPU将访问I/O端口。 这时地址总线A15 ~ A0提供16位I/O口地址
  + 低电平时，表示CPU将访问存储器。 这时地址总线A19 ~ A0提供20位存储器地址

* WR（write）

  + 写控制，输出、三态、低电平有效
  + 有效时，表示CPU正在输出数据给存储器或I/O端口

* RD （read）
  
  + 读控制，输出、三态、低电平有效
  + 有效时，表示CPU正在从存储器或I/O端口读入数据

IO/M、WR和RD是最基本的控制信号, 组合后，控制4种基本的总线周期

![alt](http://m.qpic.cn/psc?/V11NehB63qJi50/xZikVHqhLrt9jsfqm9tF*Wnh6pMryuBllNYlmZrmEsTVOtg6roBSR9rNAi8PM7ukcnfJfEg*HXIzcOAYc3Sl6Q!!/b&bo=BANDAQAAAAADB2c!&rf=viewer_4)

* DEN（data enable） 

  + 数据允许，输出、三态、低电平有效
  + 有效时，表示当前数据总线上正在传送数据，可用来控制对数据总线的驱动 

* DT/R（data transmit/receive）

  + 数据发送/接收，输出、三态
  + 该信号表明当前总线上数据的流向
    - 高电平时数据自CPU输出（发送）
    - 低电平时数据输入CPU（接收）

* READY
  
  + 存储器或I/O口就绪，输入、高电平有效
  + 总线操作周期中，CPU会测试该引脚
    - 如果测到有效，CPU直接进入下一步
    - 如果测到无效，CPU将插入等待周期
  + 等待周期中仍然要监测READY信号，确定是否继续插入等待周期

* INTR（interrupt request）
  
  + 可屏蔽中断请求，输入、高电平有效
  + 有效时，表示请求设备向CPU申请可屏蔽中断
  + 该中断请求是否响应受控于IF（中断允许标志），可以被屏蔽掉

* INTA（interrupt acknowledge）
  
  + 可屏蔽中断响应，输出、低电平有效
  + 有效时，表示来自INTR引脚的中断请求已被CPU响应，CPU进入中断响应周期

* NMI（non-maskable interrupt）
  
  + 非屏蔽中断请求，输入、上升沿有效
  + 有效，表示外界向CPU申请非屏蔽中断
  + 该中断请求不能被CPU屏蔽，所以优先级别高于INTR（可屏蔽中断）

主机与外设进行数据交换通常采用可屏蔽中断。非屏蔽中断通常用于处理掉电等系统故障。

* HOLD

  + 总线保持（即总线请求），输入、高电平有效
  + 有效时，表示总线请求设备向CPU申请占有总线
  + 该信号从有效回到无效时，表示总线请求设备对总线的使用已经结束，通知CPU收回对总线的控制权

* HLDA（HOLD acknowledge）

  + 总线保持响应（总线响应），输出、高电平有效
  + 有效，表示CPU已响应总线请求并已将总线释放
    - 此时CPU的地址总线、数据总线及具有三态输出能力的控制总线将全面呈现高阻，使总线请求设备可以顺利接管总线
    - 待到总线请求信号HOLD无效，总线响应信号HLDA也转为无效，CPU重新获得总线控制权

* RESET
  
  + 复位请求，输入、高电平有效
  + 有效时，将使CPU回到其初始状态
  + 当他再度返回无效时，CPU将重新开始工作
  + 8088复位后CS＝FFFFH、IP＝0000H，所以程序入口在物理地址FFFF0H

* CLK（Clock）

  + 时钟输入，给CPU提供内部定时信号
    - 8088的标准工作时钟为5MHz
    - IBM PC/XT机的8088采用了4.77MHz的时钟

* MN/MX（minimum/maximum）

  + 组态选择，输入
  + 接高电平时，8088引脚工作在最小组态
  + 反之，8088工作在最大组态

**最小组态模式**

构成小规模的应用系统
8088本身提供所有的系统总线信号

**最大组态模式**

构成较大规模的应用系统
8088和总线控制器8288共同形成系统总线信号

* S2、S1、S0

  + 总线周期状态标志，输出、三态
  + 3条引脚状态信号的不同组合，表示CPU总线周期的操作类型，参见表2-6（P40）
  + 最大模式下，8288利用这些信号的不同组合，产生访问存储器或I／O的控制信号或中断响应信号

* 8086的引脚与8088的区别
  
    8086有16条地址/数据复用引脚AD15~AD0。
    8088只有AD7~AD0分时复用

    8086的第34脚为BHE/S7，它是高8位数据总线的允许和状态信息复用引脚。
    8088为SS0

    8086的第28脚为M／IO
    与8088第28脚(IO／M ) 意义正好相反

## 时序

### 时序基本概念

时序（timing）是指信号高低电平、有效或无效的变化以及相互间的时间顺序关系

时序决定系统各部件之间的同步和定时

#### 指令周期

完整地执行完一条指令所用的时间
不同指令的指令周期时间长短可能不同
由若干总线周期组成

#### 总线周期

CPU通过系统总线对存储器或接口进行一次访问所需要的时间

#### 时钟周期

CLK时钟信号的周期，也称T状态
CPU最小时间单位，一般等于时钟频率的倒数
IBM PC/XT时钟频率为4.77MHz，则T=210ns

8086/8088基本总线周期需要4个时钟周期

4个时钟周期编号为T1、T2、T3和T4

当需要延长总线周期时插入等待状态Tw,
CPU进行内部操作，没有对外操作时，其引脚就处于空闲状态Ti


