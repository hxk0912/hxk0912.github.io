---
title: 定时器理解
date: 2019-10-23 23:13:30
categories: STM32底层
tags:
---

## 基本时基寄存器

1. 时钟源

定时器时钟TIMxCLK，即内部时钟CK_INT（定时器的时钟我们通常选取内部时钟），根据时钟树来，通常是APB1*2

2. 计数器时钟

定时器时钟经PSC预分频器之后，即CK_CNT。用来驱动计数器计数。CK_CNT是计数器的计数频率。
具体计算为：**CK_CNT=TIMxCLK/(PSC+1)**

3. 计数器

计数器CNT是一个16位的计数器，高级定时器有三种计数模式：递增、递减、中心对齐三种计数模式。
共同特性就是每来一个CK_CNT脉冲计数器就增加1。递增模式下，每次计数加1，直到计数器的值与自动重载寄存器ARR的值相等，然后计数器再次从零开始计数并且生成计数器上溢事件。

4. 自动重载计数器ARR

自动重载计数器用来存放与计数器CNT比较的值。

## 输入捕获

输入捕获可以对输入信号的上升沿，下降沿或者双边沿进行捕获，常用的有测量输入信号的脉宽和输入PWM的频率和占空比。
输入捕获大概的原理是，当捕获到信号的跳变沿时，把计数器CNT的值锁存到捕获寄存器CCR中，把前后两次捕获到的CCR寄存器中的值相减，就可以算出脉宽或者频率。

### PWM输入模式

使用PWM输入模式的时候，一个输入通道会占用两个捕获通道，所以最多只能使用两个输入通道。两个捕获通道在程序中设置好触发信号的极性，然后两个会在相反跳变时进行捕获。这样就是说两个捕获通道一个对应于周期，一个对应于占空比。

注意：*输入通道和捕获通道不同，输入通道输入信号，但是一个输入信号可以同时输入给两个捕获通道。*

## 输出比较

当计数器CNT的值跟比较寄存器CCR的值相等时，输出参考信号OCXREF的信号的极性就会改变。

### PWM输出模式

信号频率由自动重装寄存器ARR的值决定，占空比由比较寄存器CCR的值来决定。
比如：PWM1 模式  CNT递增计数方式  说明 CNT < CCR,通道CH为有效，否则为无效。这样就可以输出PWM波。

我们一般控制电机用的都是PWM模式的边沿对其模式，只工作于递增递减两种情况。