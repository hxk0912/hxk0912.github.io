---
title: ADC理解
date: 2020-10-02 13:28:38
categories: STM32底层
tags:
---

## ADC简介

### 电压输入范围

ADC 输入范围为：VREF- ≤ VIN ≤ VREF+。由VREF-、VREF+ 、VDDA 、VSSA、这四个外部引脚决定。

我们在设计原理图的时候一般把VSSA 和VREF-接地，把VREF+和VDDA 接3V3，得到ADC 的输入电压范围为：0~3.3V。

### 输入通道


STM32 的ADC 多达19 个通道，其中外部的16 个通道就是ADCx_IN0、
ADCx_IN1...ADCx_IN5。这16 个通道对应着不同的IO 口，具体是哪一个IO 口可以从手册查询到。

其中ADC1/2/3 还有内部通道： ADC1 的通道ADC1_IN16 连接到内部的VSS，通道ADC1_IN17 连接到了内部参考电压VREFINT，通道ADC1_IN18 连接到了芯片内部的温度传感器或者备用电源VBAT。

ADC2 和ADC3 的通道16、17、18 全部连接到了内部的VSS。

    VCC：C=circuit 表示电路的意思, 即接入电路的电压。
    VDD：D=device 表示器件的意思, 即器件内部的工作电压;
    VSS：S=series 表示公共连接的意思，通常指电路公共接地端电压。

外部的16 个通道在转换的时候又分为规则通道和注入通道，其中规则通道最多有16路，注入通道最多有4 路。

平时我们使用都是规则通道，注入通道可以在规则通道进行转换的时候进行插队，当注入通道完成转换后再进行规则通道的转换。

### 触发源

ADC触发包括三种方式：软件触发、内部定时器触发、外部IO触发

如果使用外部触发，还可以控制触发状态：禁止、上升沿、下降沿、上升沿和下降沿

### 转换时间

#### ADC时钟

ADC挂载在APB2高速时钟线下，输入始终最大为36Mhz，典型值为30Mhz。

通常，PCLK2=HCLK/2 = 84Mhz 所以程序一般使用4分频或6分频

#### 采样时间

ADC 需要若干个ADC_CLK 周期完成对输入的电压进行采样。其中采样周期最小是3 个，即如果我们要达到最快的采样，那么应该设置采样周期
为3 个周期，这里说的周期就是1/ADC_CLK。

ADC 的总转换时间跟ADC 的输入时钟和采样时间有关，公式为：Tconv = 采样时间 + 12 个周期

当ADCCLK = 30MHz，即PCLK2 为60MHz，ADC 时钟为2 分频，采样时间设置为3个周期，那么总的转换时为：Tconv = 3 + 12 = 15 个周期 

一般我们设置PCLK2=84MHz，经过ADC 预分频器能分频到最大的时钟只能是21M，采样周期设置为3 个周期，算出最短的转换时间为0.7142us，这个才是最常用的。

### 电压转换

我们一般在设计原理图的时候会把ADC 的输入电压范围设定在：0~3.3v，如果设置ADC 为12 位的，那么12 位满量程对应的就是3.3V，12 位满量程对应的数字值是：2^12。

数值0 对应的就是0V。如果转换后的数值为 X ，X 对应的模拟电压为Y，那么会有这么一个等式成立： 2^12 / 3.3 = X / Y，=> Y = (3.3 * X ) / 2^12。

## 多重ADC交替模式采集

AD 转换包括采样阶段和转换阶段，在采样阶段才对通道数据进行采集；而在转换阶段只是将采集到的数据进行转换为数字量输出，此刻通道数据变化不会改变转换结果。独立模式的ADC 采集需要在一个通道采集并且转换完成后才会进行下一个通道的采集。双重或者三重ADC 的机制使用两个或以上ADC 同时采样两个或以上不同通道的数据或者使用两个或以上ADC 交叉采集同一通道的数据。双重或者三重ADC 模式较独立模式一个最大的优势就是转换速度快。